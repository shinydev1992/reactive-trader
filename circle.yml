machine:
  node:
    version: 5.1.0
  services:
    - docker

dependencies:
  cache_directories:
    - ~/.npm
  override:
    - docker info
    # pull base containers
    - . ./deploy/config && docker pull $nginxContainer:$vNginx
    - . ./deploy/config && docker pull $crossbarContainer:$vCrossbar
    - . ./deploy/config && docker pull $monoContainer:$vDnx
    - . ./deploy/config && docker pull $eventstoreContainer:$vEventstore
    # Insure permissions 
    - chmod 755 deploy/docker/prepare
    - chmod 755 deploy/docker/build/servers/build.sh
    - chmod 755 deploy/docker/build/broker/build.sh
    - chmod 755 deploy/docker/build/populatedEventstore/build.sh
    - chmod 755 deploy/docker/build/web/build.sh
    # build AdaptiveTrader containers
    - cd deploy/docker && ./prepare build servers $CIRCLE_BUILD_NUM
    - cd deploy/docker && ./prepare build broker $CIRCLE_BUILD_NUM
    - cd deploy/docker && ./prepare build populatedEventstore $CIRCLE_BUILD_NUM
    - cd deploy/docker && ./prepare build web $CIRCLE_BUILD_NUM

test:
  override:
      - . ./deploy/config && docker run -d --net=host $webContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM
      - . ./deploy/config && docker run -d --net=host $populatedEventstoreContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM
      - . ./deploy/config && docker run -d --net=host $brokerContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM
      - . ./deploy/config && docker run -d --net=host $serversContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM bash -c "dnx --configuration Release -p Adaptive.ReactiveTrader.Server.Launcher run ref && while true; do echo ping; sleep 60; done"
      - . ./deploy/config && docker run -d --net=host $serversContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM bash -c "dnx --configuration Release -p Adaptive.ReactiveTrader.Server.Launcher run p && while true; do echo ping; sleep 60; done"
      - . ./deploy/config && docker run -d --net=host $serversContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM bash -c "dnx --configuration Release -p Adaptive.ReactiveTrader.Server.Launcher run exec && while true; do echo ping; sleep 60; done"
      - . ./deploy/config && docker run -d --net=host $serversContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM bash -c "dnx --configuration Release -p Adaptive.ReactiveTrader.Server.Launcher run b && while true; do echo ping; sleep 60; done"
      - docker ps
      - . ./deploy/config && docker run --net=host $testtoolsContainer:$vTesttools bash -c "curl -H \"Accept: application/json\" http://127.0.0.1:2113/streams/ccyPair-CADJPY | ./jq '.streamId == \"ccyPair-CADJPY\"'"

deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - . ./deploy/config && docker push $serversContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM
      - . ./deploy/config && docker push $populatedEventstoreContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM
      - . ./deploy/config && docker push $brokerContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM
      - . ./deploy/config && docker push $webContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM
