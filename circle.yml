machine:
  node:
    version: 5.3.0
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - deploy/docker/build/servers/dnxcache
  pre:
    - npm install -g npm@3.5
    #- sudo apt-get install gcc-4.8 g++-4.8
    - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.8 50
  override:
    - docker info
    - cd deploy/circleCi && chmod 755 ensurePermissions && ./ensurePermissions
    - cd deploy/circleCi && ./loadContainers
    - cd deploy/circleCi && ./buildContainers
    - cd deploy/circleCi && ./runContainers
    - cd deploy/circleCi && ./saveContainers

test:
  override:
    - docker ps
    # ping Eventstore
    - curl http://localhost:2113/web/index.html
    # test servers
    - . ./deploy/config && docker run -a STDOUT --net=host $serversContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM bash -c "dnx --configuration Release -p Adaptive.ReactiveTrader.Server.IntegrationTests test -parallel none"
    # ping Web
    - curl http://localhost

deployment:
  hub:
    branch: [master]
    commands:
      - cd deploy/circleCi && ./pushContainers