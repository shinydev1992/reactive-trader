machine:
  node:
    version: 5.1.0
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - deploy/docker/build/servers/dnxcache
  pre:
    - npm install -g npm@3.5
    - sudo apt-get install gcc-4.8 g++-4.8
  override:
    - docker info
    - cp deploy/sample.config deploy/config
    - cd deploy/circleCi && chmod 755 ensurePermissions && ./ensurePermissions
    - cd deploy/circleCi && ./loadContainers
    - cd deploy/circleCi && ./buildContainers
    - cd deploy/circleCi && ./runContainers
    - cd deploy/circleCi && ./saveContainers

test:
  override:
    - . ./deploy/config && docker run -a STDOUT --net=host $serversContainer:$vMajor.$vMinor.$CIRCLE_BUILD_NUM bash -c "dnx --configuration Release -p Adaptive.ReactiveTrader.Server.IntegrationTests test -parallel none"
    - docker ps

deployment:
  hub:
    branch: [master, deployment-dev]
    commands:
      - cd deploy/circleCi && ./pushContainers